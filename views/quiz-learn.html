<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tryb nauki â€” LearnIt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/stylesheets/style.css">
</head>

<body>
  <!-- Main -->
  <main class="container py-4">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <h3 class="mb-4 text-center">ðŸ§  Tryb nauki</h3>

        <div class="card p-4">
          <div class="mb-3">
            <label class="form-label fw-semibold" for="tagSelect">Przedmiot</label>
            <select id="tagSelect" class="form-select">
              <option disabled selected>Wczytywanie...</option>
            </select>
          </div>

          <div class="d-flex justify-content-center">
            <button id="start" class="btn btn-primary btn-lg mt-2">Rozpocznij naukÄ™</button>
          </div>
        </div>

        <div id="cardArea" class="d-none mt-4">
          <div class="text-end mb-2">
            <strong>PozostaÅ‚o:</strong> <span id="rem">0</span>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 id="qText"></h5>
              <div id="opts" class="list-group mt-3"></div>
              <div id="explain" class="mt-3 explain d-none"></div>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-center">
            <button id="next" class="btn btn-secondary btn-lg">NastÄ™pne</button>
          </div>
        </div>

      </div>
    </div>
  </main>

  <script src="/static/javascripts/script.js"></script>
  <script>
    setupThemeToggle('toggleTheme');

    let queue = [];
    let answered = false;
    let correct = false;

    // ðŸ”¹ Load tags from backend and fill <select>
    async function loadTags() {
      try {
        const res = await fetch('/api/questions/tags?language=pol');
        const data = await res.json();
        console.log(data)
        const tagSelect = document.getElementById('tagSelect');
        tagSelect.innerHTML = '';
        data.tags.forEach(tag => {
          const opt = document.createElement('option');
          opt.value = tag; // original value for backend
          opt.textContent = tag.replace(/_/g, ' '); // display prettier name
          tagSelect.appendChild(opt);
        });
      } catch (err) {
        console.error('Failed to load tags:', err);
      }
    }

    // ðŸ”¹ Load random questions by tag
    async function loadQuestions(tag) {
      try {
        const token = localStorage.getItem('token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = 'Bearer ' + token;

        const body = { language: 'pol', tag, amount: 5 };
        const res = await fetch('/api/questions/random', {
          method: 'POST',
          headers,
          body: JSON.stringify(body)
        });

        if (res.ok) {
          const data = await res.json();
          return data.questions || [];
        }
      } catch (e) {
        console.error(e);
      }
      return [];
    }

    async function startLearning() {
      const tag = document.getElementById('tagSelect').value;
      const qs = await loadQuestions(tag);
      queue = qs.map(x => Object.assign({}, x));
      document.getElementById('rem').textContent = queue.length;
      document.getElementById('cardArea').classList.remove('d-none');
      render();
    }

    function render() {
      const qText = document.getElementById('qText');
      const opts = document.getElementById('opts');
      const explain = document.getElementById('explain');
      const nextBtn = document.getElementById('next');

      if (queue.length === 0) {
        qText.textContent = 'Brawo â€” przerobione wszystkie pytania!';
        opts.innerHTML = '';
        explain.classList.add('d-none');
        nextBtn.disabled = true;
        return;
      }

      const q = queue[0];
      qText.textContent = q.q || q.question || 'Brak pytania';
      opts.innerHTML = '';
      explain.classList.add('d-none');
      answered = false;
      correct = false;
      nextBtn.disabled = true;

      const choices = q.options || q.choices || q.answers || [];
      choices.forEach((o, i) => {
        const b = document.createElement('button');
        b.className = 'list-group-item list-group-item-action';
        b.textContent = o;
        b.onclick = () => {
          if (answered) return;
          answered = true;
          correct = (i === (q.answer ?? q.correctIndex));

          if (correct) {
            b.classList.add('list-group-item-success');
            explain.textContent = 'âœ… Dobrze!';
          } else {
            b.classList.add('list-group-item-danger');
            explain.textContent = q.explain || q.explanation || 'Poprawna odpowiedÅº zostaÅ‚a zapisana.';
          }

          explain.classList.remove('d-none');
          nextBtn.disabled = false;
        };
        opts.appendChild(b);
      });
    }

    document.getElementById('start').addEventListener('click', startLearning);

    document.getElementById('next').addEventListener('click', () => {
      if (!answered) return;
      const q = queue.shift();
      if (!correct) queue.push(q);
      document.getElementById('rem').textContent = queue.length;
      render();
    });

    // Load tags immediately when page loads
    loadTags();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
