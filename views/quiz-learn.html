<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tryb nauki ‚Äî LearnIt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/stylesheets/style.css">
</head>

<body>
   <!-- Main -->
  <main class="container py-4">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <h3 class="mb-4 text-center">üß† Tryb nauki</h3>

        <div class="card p-4">
        <div class="mb-3">
          <label class="form-label fw-semibold">Przedmiot</label>
          <select id="subject" class="form-select">
            <option value="">‚è≥ ≈Åadowanie przedmiot√≥w...</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Tryb pyta≈Ñ</label>
          <select id="mode" class="form-select">
            <option value="all" selected>Wszystkie pytania</option>
            <option value="unanswered">Nieodpowiedziane</option>
            <option value="incorrect">B≈Çƒôdne odpowiedzi</option>
            <option value="saved">Zapisane pytania</option>
            <option value="random">Losowe pytania</option>

          </select>
        </div>

          <div class="d-flex justify-content-center">
            <button id="start" class="btn btn-primary btn-lg mt-2">Rozpocznij naukƒô</button>
          </div>
        </div>

        <div id="cardArea" class="d-none mt-4">    
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span id="progress-label">Pytanie 1 / 10</span>
            </div>
            <div class="progress" style="height: 20px;">
              <div id="progress-bar" class="progress-bar bg-success" role="progressbar"
                  style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 id="qText"></h5>
              <div id="opts" class="list-group mt-3"></div>
              <div id="explain" class="mt-3 explain d-none"></div>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-center">
            <button id="next" class="btn btn-secondary btn-lg">Nastƒôpne</button>
          </div>
        </div>

      </div>
    </div>
  </main>

  <script src="/static/javascripts/script.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', initQuizPage);

async function initQuizPage() {
  const subjectSelect = document.getElementById('subject');
  const startBtn = document.getElementById('start');
  const nextBtn = document.getElementById('next');
  const qText = document.getElementById('qText');
  const opts = document.getElementById('opts');
  const explain = document.getElementById('explain');
  const progressLabel = document.getElementById('progress-label');
  const progressBar = document.getElementById('progress-bar');

  let queue = [];
  let answered = false;
  let correct = false;
  let answeredCount = 0;
  let totalQuestions = 0;

  // ========================
  // üü¢ 1Ô∏è‚É£ Pobierz listƒô przedmiot√≥w
  // ========================
  try {
    const res = await fetch('/api/subjects?lang=pl');
    const subjects = await res.json();

    subjectSelect.innerHTML = '';
    if (!subjects.length) {
      subjectSelect.innerHTML = '<option value="">Brak przedmiot√≥w w bazie</option>';
      return;
    }

    subjects.forEach(subj => {
      const option = document.createElement('option');
      option.value = subj._id;
      option.textContent = `${subj.name} (sem. ${subj.semester})`;
      subjectSelect.appendChild(option);
    });
  } catch (err) {
    console.error('B≈ÇƒÖd podczas pobierania przedmiot√≥w:', err);
    subjectSelect.innerHTML = '<option value="">B≈ÇƒÖd ≈Çadowania danych</option>';
  }

  // ========================
  // üü¢ 2Ô∏è‚É£ Funkcje pomocnicze
  // ========================

  function getAuthHeaders() {
    const token = localStorage.getItem('token');
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers['Authorization'] = 'Bearer ' + token;
    return headers;
  }

  async function loadQuestions(subjectId, mode = 'all', lang = 'pl') {
    try {
      const res = await fetch(`/api/questions?subject=${encodeURIComponent(subjectId)}&mode=${mode}&lang=${lang}`, {
        headers: getAuthHeaders()
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const { totalCount, questions } = await res.json();
      totalQuestions = totalCount;
      return questions;
    } catch (e) {
      console.error('B≈ÇƒÖd podczas pobierania pyta≈Ñ:', e);
      return [];
    }
  }

  async function saveAnswerToDB(questionId, isCorrect) {
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
      await fetch('/api/user-answers/save', {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({ questionId, correct: isCorrect })
      });
    } catch (err) {
      console.error('‚ùå B≈ÇƒÖd zapisu odpowiedzi:', err);
    }
  }

  // ========================
  // üü¢ 3Ô∏è‚É£ Logika renderowania
  // ========================

  function renderProgress(currentNumber) {
    const total = totalQuestions || 0;
    const percent = total ? Math.round((currentNumber / total) * 100) : 0;
    progressLabel.textContent = `Pytanie nr ${currentNumber}${total ? ' / ' + total : ''}`;
    progressBar.style.width = `${percent}%`;
    progressBar.setAttribute('aria-valuenow', percent);
  }

  function renderQuestion(q) {
    qText.textContent = q.question || 'Brak tre≈õci pytania';
    opts.innerHTML = '';
    explain.classList.add('d-none');
    nextBtn.disabled = true;
    answered = false;
    correct = false;

    renderProgress(q.number || '?');

    q.answers.forEach((ans) => {
      const btn = document.createElement('button');
      btn.className = 'list-group-item list-group-item-action';
      btn.textContent = ans.text;

      btn.onclick = async () => handleAnswerClick(q, ans, btn);
      opts.appendChild(btn);
    });
  }

  async function handleAnswerClick(q, ans, btn) {
    if (answered) return;
    answered = true;
    correct = ans.isCorrect;
    Array.from(opts.children).forEach(b => (b.disabled = true));

    if (correct) {
      btn.classList.add('list-group-item-success');
      explain.textContent = '‚úÖ Dobrze!';
      await saveAnswerToDB(q._id, true);
    } else {
      btn.classList.add('list-group-item-danger');
      explain.innerHTML = `
        <div class="alert alert-warning">
          ‚ùå ${ans.explanation || 'Niepoprawna odpowied≈∫.'}
        </div>
      `;
      explain.appendChild(createShowCorrectButton(q, btn));
      explain.appendChild(createSaveButton(q));
      await saveAnswerToDB(q._id, false);
    }

    explain.classList.remove('d-none');
    nextBtn.disabled = false;
  }

  function createShowCorrectButton(q) {
    const showBtn = document.createElement('button');
    showBtn.className = 'btn btn-outline-success mt-2';
    showBtn.textContent = 'üëÄ Poka≈º poprawnƒÖ odpowied≈∫';
    showBtn.onclick = () => {
      const correctAns = q.answers.find(a => a.isCorrect);
      if (!correctAns) return;
      Array.from(opts.children).forEach(b => {
        if (b.textContent === correctAns.text) b.classList.add('list-group-item-success');
      });
      explain.innerHTML += `
        <div class="alert alert-info mt-2">
          <strong>üí° Poprawna odpowied≈∫:</strong> ${correctAns.text}<br>
          <em>${correctAns.explanation}</em>
        </div>
      `;
      showBtn.disabled = true;
    };
    return showBtn;
  }

  function createSaveButton(q) {
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-outline-primary mt-2 ms-2';
    saveBtn.textContent = 'üíæ Zapamiƒôtaj pytanie';
    saveBtn.onclick = async () => {
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch('/api/user-answers/toggle-save', {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({ questionId: q._id })
      });
      const data = await res.json();
      if (data.saved) {
        saveBtn.classList.replace('btn-outline-primary', 'btn-success');
        saveBtn.textContent = '‚úÖ Zapamiƒôtano';
      } else {
        saveBtn.classList.replace('btn-success', 'btn-outline-primary');
        saveBtn.textContent = 'üíæ Zapamiƒôtaj pytanie';
      }
    };
    return saveBtn;
  }

  // ========================
  // üü¢ 4Ô∏è‚É£ Obs≈Çuga przycisk√≥w
  // ========================

  startBtn.addEventListener('click', async () => {
    const subj = subjectSelect.value;
    const mode = document.getElementById('mode')?.value || 'all';
    if (!subj) return alert('‚ùó Wybierz przedmiot zanim rozpoczniesz naukƒô.');

    queue = await loadQuestions(subj, mode);
    if (!queue.length) return alert('Brak pyta≈Ñ dla wybranego przedmiotu.');

    answeredCount = 0;
    document.getElementById('cardArea').classList.remove('d-none');
    renderQuestion(queue[0]);
  });

  nextBtn.addEventListener('click', () => {
    if (!answered) return;
    const current = queue.shift();
    answeredCount++;
    if (!correct) queue.push(current);
    if (queue.length === 0) {
      qText.textContent = 'üéâ Brawo ‚Äî przerobione wszystkie pytania!';
      opts.innerHTML = '';
      explain.classList.add('d-none');
      nextBtn.disabled = true;
      progressLabel.textContent = 'Zako≈Ñczono!';
      progressBar.style.width = '100%';
      progressBar.classList.add('bg-info');
      return;
    }
    renderQuestion(queue[0]);
  });
}
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
