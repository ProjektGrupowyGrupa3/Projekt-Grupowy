<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tryb Test — LearnIt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/stylesheets/style.css">
</head>
<body>
<main class="container py-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <h3>Tryb testowy</h3>
      <form id="settingsForm" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Tag</label>
          <select id="tagSelect" class="form-select">
            <option disabled selected>Wczytywanie tagów...</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Ilość pytań</label>
          <input type="number" id="count" class="form-control" min="1" max="50" value="5">
        </div>
        <div class="col-md-4">
          <label class="form-label">Czas (minuty)</label>
          <input type="number" id="time" class="form-control" min="1" max="120" value="10">
        </div>
        <div class="col-12">
          <button class="btn btn-primary" id="startBtn" type="button">Rozpocznij test</button>
        </div>
      </form>

      <div id="quizArea" class="mt-4 d-none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>Timer: <span id="timer">00:00</span></div>
          <div>Pytanie <span id="curIdx">0</span>/<span id="total">0</span></div>
        </div>
        <div id="questionCard" class="card">
          <div class="card-body">
            <h5 id="questionText"></h5>
            <div id="answers" class="list-group mt-3"></div>
          </div>
        </div>
        <div class="mt-3 d-flex justify-content-between">
          <button id="prevBtn" class="btn btn-outline-secondary">Poprzednie</button>
          <button id="nextBtn" class="btn btn-primary">Następne</button>
        </div>
      </div>

      <div id="resultArea" class="mt-4 d-none"></div>
    </div>
  </div>
</main>

<script src="/static/javascripts/script.js"></script>
<script>
  setupThemeToggle('toggleTheme');

  let state = {questions:[], answers:[], cur:0, timer:null, timeLeft:0};

  async function loadTags() {
    try {
      const res = await fetch('/api/questions/tags?language=pol');
      const data = await res.json();
      const tagSelect = document.getElementById('tagSelect');
      tagSelect.innerHTML = '';
      data.tags.forEach(tag => {
        const opt = document.createElement('option');
        opt.value = tag; 
        opt.textContent = tag.replace(/_/g,' ');
        tagSelect.appendChild(opt);
      });
    } catch (err) {
      console.error('Nie udało się wczytać tagów:', err);
    }
  }

  async function loadQuestions(tag, amount) {
    try {
      const token = localStorage.getItem('token');
      const headers = {'Content-Type':'application/json'};
      if(token) headers['Authorization'] = 'Bearer '+token;

      const res = await fetch('/api/questions/random', {
        method: 'POST',
        headers,
        body: JSON.stringify({ language:'pol', tag, amount })
      });
      if(res.ok){
        const data = await res.json();
        return data.questions || [];
      }
    } catch(err){
      console.error(err);
    }
    return [];
  }

  document.getElementById('startBtn').addEventListener('click', async ()=>{
    const tag = document.getElementById('tagSelect').value;
    const cnt = parseInt(document.getElementById('count').value)||5;
    const mins = parseInt(document.getElementById('time').value)||10;

    const pool = await loadQuestions(tag, cnt);
    state.questions = pool;
    state.answers = Array(pool.length).fill(null);
    state.cur = 0;
    state.timeLeft = mins*60;

    document.getElementById('total').textContent = pool.length;
    document.getElementById('curIdx').textContent = 1;
    document.getElementById('quizArea').classList.remove('d-none');
    document.getElementById('resultArea').classList.add('d-none');

    renderQuestion();

    if(state.timer) clearInterval(state.timer);
    state.timer = setInterval(()=>{
      state.timeLeft--;
      updateTimer();
      if(state.timeLeft<=0){
        clearInterval(state.timer);
        finishTest();
      }
    },1000);
    updateTimer();
  });

  function updateTimer(){
    const m = Math.floor(state.timeLeft/60).toString().padStart(2,'0');
    const s = (state.timeLeft%60).toString().padStart(2,'0');
    document.getElementById('timer').textContent = m+':'+s;
  }

  function renderQuestion(){
    const q = state.questions[state.cur];
    document.getElementById('questionText').textContent = q.q || 'Brak pytania';
    const answers = document.getElementById('answers');
    answers.innerHTML = '';
    const opts = q.options || [];
    opts.forEach((opt,i)=>{
      const btn = document.createElement('button');
      btn.className = 'list-group-item list-group-item-action';
      btn.textContent = opt;
      btn.onclick = ()=> {
        state.answers[state.cur] = i;
        [...answers.children].forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
      };
      answers.appendChild(btn);
    });
    document.getElementById('curIdx').textContent = state.cur+1;
  }

  document.getElementById('prevBtn').addEventListener('click', ()=>{
    if(state.cur>0){ state.cur--; renderQuestion(); highlightSelected(); }
  });

  document.getElementById('nextBtn').addEventListener('click', ()=>{
    if(state.cur < state.questions.length-1){
      state.cur++;
      renderQuestion();
      highlightSelected();
    } else finishTest();
  });

  function highlightSelected(){
    const selected = state.answers[state.cur];
    const btns = document.getElementById('answers').children;
    if(selected!==null && btns[selected]) btns[selected].classList.add('active');
  }

  function finishTest(){
    if(state.timer) clearInterval(state.timer);
    let correct = 0;
    state.questions.forEach((q,i)=>{
      const ans = state.answers[i];
      const right = q.answer ?? q.correctIndex;
      if(ans===right) correct++;
    });
    const res = document.getElementById('resultArea');
    res.classList.remove('d-none');
    res.innerHTML = `<div class="alert alert-info">Wynik: ${correct}/${state.questions.length}</div>`;
    document.getElementById('quizArea').classList.add('d-none');
  }

  // Load tags immediately
  loadTags();

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
