<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tryb nauki â€” LearnIt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../public/stylesheets/style.css">
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">LearnIt</a>
      <div class="d-flex ms-auto">
        <button id="toggleTheme" class="btn btn-outline-light me-2">Toggle Dark/Light</button>
        <span id="userEmail" class="me-3"></span>
        <a id="authBtn" class="btn btn-outline-light me-2" href="login.html">Zaloguj</a>
        <a id="regBtn" class="btn btn-secondary" href="register.html">Rejestracja</a>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="container py-4">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <h3 class="mb-4 text-center">ðŸ§  Tryb nauki</h3>

        <div class="card p-4">
          <div class="mb-3">
            <label class="form-label fw-semibold">Przedmiot</label>
            <select id="subject" class="form-select">
              <option value="math">Matematyka</option>
              <option value="cs">Programowanie</option>
              <option value="sec">BezpieczeÅ„stwo</option>
            </select>
          </div>

          <div class="d-flex justify-content-center">
            <button id="start" class="btn btn-primary btn-lg mt-2">Rozpocznij naukÄ™</button>
          </div>
        </div>

        <div id="cardArea" class="d-none mt-4">
          <div class="text-end mb-2">
            <strong>PozostaÅ‚o:</strong> <span id="rem">0</span>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 id="qText"></h5>
              <div id="opts" class="list-group mt-3"></div>
              <div id="explain" class="mt-3 explain d-none"></div>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-center">
            <button id="next" class="btn btn-secondary btn-lg">NastÄ™pne</button>
          </div>
        </div>

      </div>
    </div>
  </main>

  <script src="scripts/scrypt.js"></script>
  <script>
    setupThemeToggle('toggleTheme');
    const SAMPLE = {
      math: [
        { id: 1, q: '2+2=?', options: ['3', '4', '5', '22'], answer: 1, explain: '2+2=4' },
        { id: 2, q: 'Ile to 5*6?', options: ['30', '11', '56', '28'], answer: 0, explain: '5*6 = 30' }
      ],
      cs: [
        { id: 10, q: 'Co robi HTML?', options: ['Styluje', 'Strukturyzuje', 'Programuje', 'Nic'], answer: 1, explain: 'HTML definiuje strukturÄ™ dokumentu.' },
        { id: 11, q: 'JS jest jÄ™zykiem:', options: ['Statycznym', 'Skryptowym', 'Bajtowym', 'Natywnym'], answer: 1, explain: 'JavaScript jest jÄ™zykiem skryptowym.' }
      ],
      sec: [
        { id: 20, q: 'Co to XSS?', options: ['Atak', 'ProtokoÅ‚', 'NarzÄ™dzie', 'BÅ‚Ä…d'], answer: 0, explain: 'XSS = Cross-site scripting â€” atak.' }
      ]
    };

    let queue = [];
    let answered = false;
    let correct = false;

    async function loadQuestions(subj) {
      try {
        const token = localStorage.getItem('token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = 'Bearer ' + token;
        const res = await fetch(`/api/questions?subject=${encodeURIComponent(subj)}`, { headers });
        if (res.ok) {
          const data = await res.json();
          return data;
        }
      } catch (e) { }
      return SAMPLE[subj] || [];
    }

    async function startLearning() {
      const subj = document.getElementById('subject').value;
      const qs = await loadQuestions(subj);
      queue = qs.map(x => Object.assign({}, x));
      document.getElementById('rem').textContent = queue.length;
      document.getElementById('cardArea').classList.remove('d-none');
      render();
    }

    function render() {
      const qText = document.getElementById('qText');
      const opts = document.getElementById('opts');
      const explain = document.getElementById('explain');
      const nextBtn = document.getElementById('next');

      if (queue.length === 0) {
        qText.textContent = 'Brawo â€” przerobione wszystkie pytania!';
        opts.innerHTML = '';
        explain.classList.add('d-none');
        nextBtn.disabled = true;
        return;
      }

      const q = queue[0];
      qText.textContent = q.q || q.question || 'Brak pytania';
      opts.innerHTML = '';
      explain.classList.add('d-none');
      answered = false;
      correct = false;
      nextBtn.disabled = true;

      const choices = q.options || q.choices || q.answers || [];
      choices.forEach((o, i) => {
        const b = document.createElement('button');
        b.className = 'list-group-item list-group-item-action';
        b.textContent = o;
        b.onclick = () => {
          if (answered) return; // nie pozwÃ³l kliknÄ…Ä‡ wiÄ™cej niÅ¼ raz
          answered = true;
          correct = (i === (q.answer ?? q.correctIndex));

          if (correct) {
            b.classList.add('list-group-item-success');
            explain.textContent = 'âœ… Dobrze!';
            explain.classList.remove('d-none');
          } else {
            b.classList.add('list-group-item-danger');
            explain.textContent = q.explain || q.explanation || 'Poprawna odpowiedÅº zostaÅ‚a zapisana.';
            explain.classList.remove('d-none');
          }

          // odblokuj przycisk "NastÄ™pne"
          nextBtn.disabled = false;
        };
        opts.appendChild(b);
      });
    }

    document.getElementById('start').addEventListener('click', startLearning);

    document.getElementById('next').addEventListener('click', () => {
      if (!answered) return; // nic nie rÃ³b, jeÅ›li user jeszcze nie odpowiedziaÅ‚
      const q = queue.shift();
      if (!correct) queue.push(q); // bÅ‚Ä™dne wraca na koniec kolejki
      document.getElementById('rem').textContent = queue.length;
      render();
    });

  </script>

  <!-- Theme script -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>