<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tryb Test — LearnIt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../public/stylesheets/style.css">
</head>
<body>
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">LearnIt</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <div class="ms-auto d-flex align-items-center">
        <button id="toggleTheme" class="btn btn-outline-light me-2">Tryb jasny/ciemny</button>
      </div>
    </div>
  </div>
</nav>

<main class="container py-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <h3>Tryb testowy</h3>
      <form id="settingsForm" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Przedmiot</label>
          <select id="subject" class="form-select">
            <option value="math">Matematyka</option>
            <option value="cs">Programowanie</option>
            <option value="sec">Bezpieczeństwo</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Ilość pytań</label>
          <input type="number" id="count" class="form-control" min="1" max="50" value="5">
        </div>
        <div class="col-md-4">
          <label class="form-label">Czas (minuty)</label>
          <input type="number" id="time" class="form-control" min="1" max="120" value="10">
        </div>
        <div class="col-12">
          <button class="btn btn-primary" id="startBtn" type="button">Rozpocznij test</button>
        </div>
      </form>

      <div id="quizArea" class="mt-4 d-none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>Timer: <span id="timer">00:00</span></div>
          <div>Pytanie <span id="curIdx">0</span>/<span id="total">0</span></div>
        </div>
        <div id="questionCard" class="card">
          <div class="card-body">
            <h5 id="questionText"></h5>
            <div id="answers" class="list-group mt-3"></div>
          </div>
        </div>
        <div class="mt-3 d-flex justify-content-between">
          <button id="prevBtn" class="btn btn-outline-secondary">Poprzednie</button>
          <button id="nextBtn" class="btn btn-primary">Następne</button>
        </div>
      </div>

      <div id="resultArea" class="mt-4 d-none"></div>
    </div>
  </div>
</main>

<script src="scripts/scrypt.js"></script>
<script>

  setupThemeToggle('toggleTheme');

  const SAMPLE = {
    math: [
      {id:1, q:'2+2=?', options:['3','4','5','22'], answer:1, explain:'2+2=4'},
      {id:2, q:'Ile to 5*6?', options:['30','11','56','28'], answer:0, explain:'5*6 = 30'}
    ],
    cs: [
      {id:10, q:'Co robi HTML?', options:['Styluje','Strukturyzuje','Programuje', 'Nic'], answer:1, explain:'HTML definiuje strukturę dokumentu.'},
      {id:11, q:'JS jest językiem:', options:['Statycznym','Skryptowym','Bajtowym','Natywnym'], answer:1, explain:'JavaScript jest językiem skryptowym.'}
    ],
    sec: [
      {id:20, q:'Co to XSS?', options:['Atak','Protokoł','Narzędzie','Błąd'], answer:0, explain:'XSS = Cross-site scripting — atak.'}
    ]
  };

  let state = {questions:[], answers:[], cur:0, timer:null, timeLeft:0};

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  document.getElementById('startBtn').addEventListener('click', async ()=> {
    const subj = document.getElementById('subject').value;
    const cnt = parseInt(document.getElementById('count').value)||5;
    const mins = parseInt(document.getElementById('time').value)||10;

    let pool = [];
    try {
      const token = localStorage.getItem('token');
      const headers = {'Content-Type':'application/json'};
      if(token) headers['Authorization'] = 'Bearer '+token;
      const res = await fetch(`/api/questions?subject=${encodeURIComponent(subj)}&limit=${cnt}`, {headers});
      pool = res.ok ? await res.json() : SAMPLE[subj]||[];
    } catch {
      pool = SAMPLE[subj]||[];
    }

    pool = shuffle(pool).slice(0,cnt);
    state.questions = pool;
    state.answers = Array(pool.length).fill(null);
    state.cur = 0;
    state.timeLeft = mins*60;
    document.getElementById('total').textContent = pool.length;
    document.getElementById('curIdx').textContent = 1;
    document.getElementById('quizArea').classList.remove('d-none');
    document.getElementById('resultArea').classList.add('d-none');
    renderQuestion();

    if(state.timer) clearInterval(state.timer);
    state.timer = setInterval(()=> {
      state.timeLeft--;
      updateTimer();
      if(state.timeLeft<=0){
        clearInterval(state.timer);
        finishTest();
      }
    },1000);
    updateTimer();
  });

  function updateTimer(){
    const m = Math.floor(state.timeLeft/60).toString().padStart(2,'0');
    const s = (state.timeLeft%60).toString().padStart(2,'0');
    document.getElementById('timer').textContent = m+':'+s;
  }

  function renderQuestion(){
    const q = state.questions[state.cur];
    document.getElementById('questionText').textContent = q.q || q.question || 'Brak pytania';
    const answers = document.getElementById('answers');
    answers.innerHTML = '';
    const opts = q.options || q.choices || q.answers || [];
    opts.forEach((opt,i)=>{
      const btn = document.createElement('button');
      btn.className = 'list-group-item list-group-item-action';
      btn.textContent = opt;
      btn.onclick = ()=> {
        state.answers[state.cur] = i;
        [...answers.children].forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
      };
      answers.appendChild(btn);
    });
    document.getElementById('curIdx').textContent = state.cur+1;
  }

  document.getElementById('prevBtn').addEventListener('click', ()=> {
    if(state.cur>0){ state.cur--; renderQuestion(); highlightSelected(); }
  });

  document.getElementById('nextBtn').addEventListener('click', ()=> {
    if(state.cur < state.questions.length-1){
      state.cur++;
      renderQuestion();
      highlightSelected();
    } else finishTest();
  });

  function highlightSelected(){
    const selected = state.answers[state.cur];
    const btns = document.getElementById('answers').children;
    if(selected!==null && btns[selected]) btns[selected].classList.add('active');
  }

  function finishTest(){
    if(state.timer) clearInterval(state.timer);
    let correct = 0;
    state.questions.forEach((q,i)=>{
      const ans = state.answers[i];
      const right = q.answer || q.correctIndex;
      if(ans===right) correct++;
    });
    const res = document.getElementById('resultArea');
    res.classList.remove('d-none');
    res.innerHTML = `<div class="alert alert-info">Wynik: ${correct}/${state.questions.length}</div>`;
    document.getElementById('quizArea').classList.add('d-none');
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
